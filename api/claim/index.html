<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Claim your display</title>
  <style>
    body { font-family: system-ui, -apple-system; margin: 24px; }
    input, button { font-size: 16px; padding: 10px; }
    ul { list-style: none; padding: 0; }
    li { margin: 8px 0; }
    .pill { display:inline-block; padding:10px 14px; border-radius:12px; background:#eee; }
  </style>
</head>
<body>
  <h1>Claim your display</h1>

  <input id="search" placeholder="Search your business name" />
  <ul id="results"></ul>

<script>
const results = document.getElementById("results");
const search = document.getElementById("search");

async function query(q="") {
  const r = await fetch(`/api/businesses?search=${encodeURIComponent(q)}`, { cache: "no-store" });
  const items = await r.json();
  results.innerHTML = items.map(b =>
    `<li><button class="pill" onclick="claim('${b.id}')">${b.name}</button></li>`
  ).join("") || "<li>No matching business found.</li>";
}
search.addEventListener("input", e => query(e.target.value));
query();

async function claim(business_id) {
  // UID comes from the HttpOnly cookie set by /t
  const r = await fetch("/api/claim", {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({ business_id })
  });
  const data = await r.json();
  if (data.to) location.href = data.to;
  else alert("Error: " + (data.error || "unknown"));
}
</script>
</body>
</html>
