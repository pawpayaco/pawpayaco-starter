<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Claim your display</title>
  <style>
    body { font-family: system-ui, -apple-system; margin: 24px; }
    input, button { font-size: 16px; padding: 10px; }
    ul { list-style: none; padding: 0; }
    li { margin: 8px 0; }
    .uid { color: #555; font-size: 12px; margin-bottom: 16px; }
  </style>
</head>
<body>
  <h1>Claim your display</h1>
  <div class="uid" id="uidt"></div>
  <input id="search" placeholder="Search your business name" autofocus />
  <ul id="results"></ul>

<script>
const uid = new URL(location).searchParams.get("u") || "";
document.getElementById("uidt").textContent = uid ? ("Tag: " + uid) : "";

const results = document.getElementById("results");
const search = document.getElementById("search");

async function query(q="") {
  const r = await fetch(`/api/businesses?search=${encodeURIComponent(q)}`);
  const items = await r.json();
  results.innerHTML = items.map(b =>
    `<li><button onclick="claim('${uid}','${b.id}')">${b.name}</button></li>`
  ).join("") || "<li>No matching business found.</li>";
}
search.addEventListener("input", e => query(e.target.value));
query();

async function claim(uid, business_id) {
  const r = await fetch("/api/claim", {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({ uid, business_id })
  });
  const data = await r.json();
  if (data.to) location.href = data.to; else alert("Error: " + (data.error || "unknown"));
}
</script>
</body>
</html>