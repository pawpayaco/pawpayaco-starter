<!doctype html>
<meta charset="utf-8">
<script>
  // forward /t?u=... -> /api/t?u=...
  location.replace("/api/t" + location.search);
</script>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Claim your display</title>
  <style>
    :root { color-scheme: light dark; }
    body { font-family: system-ui, -apple-system; margin: 24px; line-height: 1.4; }
    input, button { font-size: 17px; padding: 12px 14px; border-radius: 12px; border: 1px solid #ccc; }
    ul { list-style: none; padding: 0; }
    li { margin: 10px 0; }
    .pill { background: rgba(127,127,127,.15); border: 1px solid rgba(127,127,127,.25); }
    .uid { color: #666; font-size: 13px; margin: 10px 0 18px; }
    .warn { background: #fff8e5; border: 1px solid #f0d48a; padding: 12px; border-radius: 12px; margin-bottom: 12px; }
    .row { display: flex; gap: 8px; }
    .row > * { flex: 1 1 auto; }
    .btn { cursor: pointer; border: none; }
  </style>
</head>
<body>
  <h1>Claim your display</h1>

  <div id="noUidBox" class="warn" style="display:none">
    <b>No tag ID found.</b> Tap your NFC link again.
  </div>

  <div class="uid" id="uidt"></div>

  <input id="search" placeholder="Search your business name" autocomplete="off" />
  <ul id="results"></ul>

<script>
function getCookie(name) {
  const m = document.cookie.match(new RegExp('(^|; )' + name + '=([^;]*)'));
  return m ? decodeURIComponent(m[2]) : "";
}
const uidFromUrl = new URL(location.href).searchParams.get("u") || "";
const uidCookie   = getCookie("puid") || "";
const uid = (uidFromUrl || uidCookie).toUpperCase().replace(/[^0-9A-F]/g, "");

const uidBox = document.getElementById("uidt");
const warn   = document.getElementById("noUidBox");

if (uid) {
  uidBox.textContent = "Tag: " + uid;
} else {
  warn.style.display = "block";
}

const results = document.getElementById("results");
const search  = document.getElementById("search");

async function query(q="") {
  const r = await fetch(`/api/businesses?search=${encodeURIComponent(q)}`);
  const items = await r.json();
  results.innerHTML = items.map(b =>
    `<li><button class="pill btn" onclick="claim('${b.id}')">${b.name}</button></li>`
  ).join("") || "<li>No matching business found.</li>";
}
search.addEventListener("input", e => query(e.target.value));
query();

async function claim(business_id) {
  if (!uid) { alert("Missing UID. Tap the tag again."); return; }
  const r = await fetch("/api/claim", {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({ uid, business_id })
  });
  const data = await r.json();
  if (data.to) location.href = data.to; else alert("Error: " + (data.error || "unknown"));
}
</script>
</body>
</html>
