<!doctype html>
<html lang="en" data-theme="aura">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Pawpaya — Claim Playground (AURA Mock)</title>
  <meta name="theme-color" content="#ff8ea3"/>
  <style>
    /* =====================
       AURA THEME — Pawpaya
       ===================== */
    :root{
      --ink:#1f2937;--muted:#6b7280;--line:#e5e7eb;--ok:#16a34a;--err:#dc2626;
      --brand:#ff7a4a;--brand-2:#ff6fb3;--brand-3:#ffd166; /* orange / pink / mango */
      --card:#ffffff;--ring:0 0 0 10px rgba(255,122,74,.12);
      --bg-1:#fff6fb;--bg-2:#fff3ea;
    }
    @media (prefers-color-scheme:dark){
      :root{--ink:#e5e7eb;--muted:#9ca3af;--line:#2a2935;--card:#1d1b24;--ring:0 0 0 12px rgba(255,111,179,.18);--bg-1:#181622;--bg-2:#211d2a}
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family: ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial; color:var(--ink);
      /* Animated conic-aurora backdrop */
      background: radial-gradient(60% 50% at 15% 5%, var(--bg-2), transparent 60%),
                  radial-gradient(60% 60% at 100% 0%, var(--bg-1), transparent 60%),
                  #fff;
      overflow-x:hidden;
    }
    /* floating blobs */
    .aura{position:fixed;inset:-20vmax;pointer-events:none;z-index:-1;filter:saturate(110%) blur(22px);opacity:.75}
    .aura::before,.aura::after{content:"";position:absolute;inset:auto;left:15%;top:10%;width:55vmax;height:55vmax;border-radius:50%;
      background:conic-gradient(from 10deg, rgba(255,122,74,.35), rgba(255,111,179,.35), rgba(255,209,102,.35), rgba(255,122,74,.35));
      animation:spin 38s linear infinite}
    .aura::after{left:auto; right:0; top:0; width:65vmax;height:65vmax; animation-duration:58s; animation-direction:reverse; filter:hue-rotate(-12deg)}
    @keyframes spin{to{transform:rotate(360deg)}}

    .wrap{max-width:920px;margin:0 auto;padding:28px}
    header{display:flex;align-items:center;justify-content:space-between;padding:10px 0 14px}
    .brand{display:flex;gap:14px;align-items:center}
    .logo{height:44px;width:44px;border-radius:14px;background:linear-gradient(135deg,var(--brand),var(--brand-2)); color:#fff; display:grid; place-items:center; font-weight:900; letter-spacing:.5px;
      box-shadow:0 10px 28px rgba(255,111,179,.25), 0 4px 12px rgba(255,122,74,.2)}
    .title{line-height:1.15;margin:0;font-size:22px;font-weight:900}
    .subtitle{margin:2px 0 0;font-size:12px;color:var(--muted)}

    .actions{display:flex;gap:10px;align-items:center}
    .toggle{border:1px solid var(--line);background:rgba(255,255,255,.5);backdrop-filter:blur(10px);height:36px;padding:0 12px;border-radius:999px;cursor:pointer;font-weight:700}

    /* Glass card with bead frame */
    .card{position:relative;background:linear-gradient(180deg, rgba(255,255,255,.65), rgba(255,255,255,.45));
      border:1px solid var(--line); border-radius:22px; padding:22px; backdrop-filter: blur(16px);
      box-shadow:0 20px 55px rgba(24,16,32,.18), inset 0 0 0 1px rgba(255,255,255,.35)}
    .ribbon{position:absolute;left:18px;top:-12px;background:#111;color:#fff;border-radius:999px;padding:7px 12px;font-size:11px;letter-spacing:.02em}
    .frame{position:absolute;inset:-6px;border-radius:26px;pointer-events:none;background:
      radial-gradient(10px 10px at 16px 16px, rgba(255,255,255,.8), transparent 60%) repeat;
      -webkit-mask: linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);
      -webkit-mask-composite: xor; mask-composite: exclude}

    /* Beaded stepper */
    .steps{position:relative;display:flex;gap:18px;align-items:center;font-size:12px;color:var(--muted);margin:6px 0 16px}
    .steps::before{content:"";position:absolute;left:16px;right:16px;top:11px;height:2px;background:linear-gradient(90deg, var(--brand), var(--brand-2), var(--brand-3))}
    .step{position:relative;display:flex;gap:8px;align-items:center}
    .dot{height:24px;width:24px;border-radius:50%;background:linear-gradient(135deg,var(--brand),var(--brand-2));color:#fff;display:grid;place-items:center;font-size:12px;font-weight:800;box-shadow:0 6px 16px rgba(255,111,179,.35)}
    .step.live .dot{filter:saturate(140%) drop-shadow(0 0 12px rgba(255,111,179,.45))}
    .step.done .dot{background:linear-gradient(135deg,#16a34a,#70e094)}

    .hdr{font-size:20px;font-weight:900;margin:6px 0}
    .p{color:var(--muted);font-size:13px;margin:0}

    .field{position:relative}
    input[type="text"]{width:100%;height:50px;border:1px solid var(--line);border-radius:16px;background:rgba(255,255,255,.7);color:var(--ink);padding:0 48px 0 16px;font-size:16px;outline:none;backdrop-filter:blur(4px)}
    input[type="text"]:focus{box-shadow:var(--ring);border-color:rgba(255,111,179,.45)}
    .searchIcon{position:absolute;right:14px;top:50%;transform:translateY(-50%);opacity:.7}

    .list{list-style:none;margin:0;padding:0;border:1px solid var(--line);border-radius:16px;overflow:hidden;background:rgba(255,255,255,.7);backdrop-filter:blur(6px)}
    .item{display:flex;justify-content:space-between;align-items:center;padding:14px 14px;border-top:1px solid var(--line);}
    .item:first-child{border-top:0}

    .bead{height:28px;width:28px;border-radius:999px;background:radial-gradient(circle at 30% 30%, #fff, rgba(255,255,255,.2) 35%, rgba(0,0,0,.05) 36%, rgba(255,111,179,.4) 100%);
      box-shadow:inset 0 2px 4px rgba(0,0,0,.08), 0 6px 14px rgba(255,111,179,.25)}

    .btn{height:42px;border:0;border-radius:12px;padding:0 16px;background:linear-gradient(135deg,var(--brand),var(--brand-2));color:#fff;font-weight:800;cursor:pointer;transition:transform .08s ease}
    .btn:active{transform:translateY(1px)}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .ghost{background:transparent;color:var(--ink);border:1px solid var(--line)}

    .muted{color:var(--muted)}
    .hint{font-size:11px;color:var(--muted)}
    .center{text-align:center}

    .spinner{height:18px;width:18px;border:3px solid rgba(0,0,0,.15);border-top-color:currentColor;border-radius:50%;animation:spin 1s linear infinite}

    .banner{padding:10px 12px;border-radius:12px;font-size:13px}
    .ok{background:rgba(34,197,94,.1);border:1px solid rgba(34,197,94,.3);color:var(--ok)}
    .err{background:rgba(220,38,38,.1);border:1px solid rgba(220,38,38,.3);color:var(--err)}

    footer{margin-top:14px;text-align:center;font-size:11px;color:var(--muted)}

    .hidden{display:none}

    /* Minimal classic fallback theme (if data-theme="classic") */
    html[data-theme="classic"] body{background:radial-gradient(1200px 700px at 10% -10%,var(--bg-2),transparent 60%),radial-gradient(1200px 700px at 100% 10%,var(--bg-1),transparent 60%),linear-gradient(180deg,var(--bg-1),var(--bg-2))}
    html[data-theme="classic"] .card{background:var(--card);backdrop-filter:none}
    html[data-theme="classic"] .dot{background:#fff;color:#111;border:1px solid var(--line)}
  </style>
</head>
<body>
  <div class="aura"></div>
  <canvas id="fx" class="aura" style="filter:none;opacity:.9;inset:0;z-index:10;pointer-events:none;"></canvas>

  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo">P</div>
        <div>
          <h1 class="title">Claim your display</h1>
          <p class="subtitle">A gorgeous mocked demo. First claim wins.</p>
        </div>
      </div>
      <div class="actions">
        <button id="themeBtn" class="toggle" title="Switch theme">Theme: Aura</button>
        <a class="toggle" href="#" id="resetDemo">Reset demo</a>
      </div>
    </header>

    <section class="card">
      <div id="uidRibbon" class="ribbon">UID: —</div>
      <div class="frame" aria-hidden="true"></div>

      <div class="steps">
        <div id="s1" class="step"><span class="dot">1</span>Detect</div>
        <div id="s2" class="step"><span class="dot">2</span>Choose</div>
        <div id="s3" class="step"><span class="dot">3</span>Redirect</div>
      </div>

      <div id="statusArea" class="grid"></div>
    </section>

    <footer>
      Edit this file in Cursor and keep a dev server running for instant updates.
    </footer>
  </div>

  <!-- UI STATES (templates) -->
  <template id="tpl-checking">
    <div class="center" style="padding:22px 6px">
      <div class="spinner" style="margin:0 auto 8px;color:var(--brand)"></div>
      <div class="muted">Checking tag status…</div>
    </div>
  </template>

  <template id="tpl-error">
    <div class="banner err"></div>
    <div class="row" style="margin-top:10px">
      <button class="btn ghost" id="retryBtn">Try again</button>
      <a class="btn" id="supportBtn" href="#">Contact support</a>
    </div>
  </template>

  <template id="tpl-claimed">
    <div class="center" style="padding:12px 6px">
      <div class="banner ok" style="display:inline-block">This tag is linked. Redirecting…</div>
      <div class="hint" style="margin-top:8px">If nothing happens, press <a id="gotoLink" class="help" href="#">continue</a>.</div>
    </div>
  </template>

  <template id="tpl-search">
    <div class="grid">
      <div>
        <div class="hdr">Select your business</div>
        <p class="p">Start typing to search.</p>
      </div>

      <div class="field" style="margin-bottom:6px">
        <input id="search" type="text" placeholder="Search your business name" autocomplete="organization"/>
        <svg class="searchIcon" width="22" height="22" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden>
          <circle cx="11" cy="11" r="7" stroke="currentColor" stroke-width="2"/>
          <path d="M20 20L17 17" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
      </div>

      <ul id="results" class="list hidden" role="listbox" aria-label="Businesses"></ul>

      <div class="row" style="margin-top:8px">
        <span class="hint">Tip: add <code>?b=Happy%20Paws</code> or <code>?claimed=1</code>. Use <code>?noredir=1</code> to preview success without navigation.</span>
      </div>
    </div>
  </template>

  <template id="tpl-empty">
    <li class="item muted" aria-disabled="true">No matching business found.</li>
  </template>

  <template id="tpl-item">
    <li class="item">
      <div class="row" style="gap:10px">
        <div class="bead" aria-hidden="true"></div>
        <div>
          <div class="name" style="font-weight:900"></div>
          <div class="hint" style="margin-top:4px"><span class="muted">ID:</span> <span class="id"></span></div>
        </div>
      </div>
      <button class="btn claimBtn">Claim</button>
    </li>
  </template>

  <script>
    // ---------------- MOCK API & DATA (single-file, no backend needed) ----------------
    const BUSINESSES = [
      { id: "b-1001", name: "Happy Paws Grooming" },
      { id: "b-1002", name: "Downtown Dog Daycare" },
      { id: "b-1003", name: "Lakeview Veterinary" },
      { id: "b-1004", name: "Good Boy Sit & Stay" },
      { id: "b-1005", name: "Paws & Relax Spa" },
      { id: "b-1006", name: "City Pet Boutique" },
      { id: "b-1007", name: "Tail Waggers Co." },
      { id: "b-1008", name: "Northside Kennels" },
      { id: "b-1009", name: "Fetch n' Run Trainers" },
      { id: "b-1010", name: "Sunset Animal Clinic" }
    ];

    const CLAIMED = new Map(); // uid -> affiliate URL

    (function installMockFetch(){
      const realFetch = window.fetch.bind(window);
      window.fetch = async (url, init={}) => {
        const u = typeof url === 'string' ? new URL(url, location.origin) : url;
        const path = (typeof url === 'string') ? u.pathname + u.search : u.toString();

        // Search businesses
        if (path.startsWith('/api/businesses')){
          const q = (u.searchParams.get('search') || '').toLowerCase();
          const items = BUSINESSES.filter(b => b.name.toLowerCase().includes(q));
          return new Response(JSON.stringify(items), { status: 200, headers: { 'Content-Type': 'application/json' } });
        }

        // Claim API
        if (path.startsWith('/api/claim')){
          const method = (init.method || 'GET').toUpperCase();
          if (method === 'GET'){
            const uid = (u.searchParams.get('u') || '').trim();
            if (CLAIMED.has(uid)){
              return new Response(JSON.stringify({ to: CLAIMED.get(uid) }), { status: 200, headers: { 'Content-Type': 'application/json' } });
            }
            return new Response(JSON.stringify({ status: 'unclaimed' }), { status: 200, headers: { 'Content-Type': 'application/json' } });
          }
          if (method === 'POST'){
            try{
              const body = JSON.parse(init.body || '{}');
              const { uid, business_id } = body;
              const aff = `https://pawpayaco.com/?aff=${encodeURIComponent(business_id)}-${encodeURIComponent(uid.slice(-4))}`;
              if (!CLAIMED.has(uid)) CLAIMED.set(uid, aff); // first claim wins
              return new Response(JSON.stringify({ to: CLAIMED.get(uid) }), { status: 200, headers: { 'Content-Type': 'application/json' } });
            }catch(e){
              return new Response(JSON.stringify({ error: 'Bad JSON' }), { status: 400, headers: { 'Content-Type': 'application/json' } });
            }
          }
        }
        return realFetch(url, init);
      };
    })();

    // ---------------- UTILITIES ----------------
    const $ = (sel, root=document) => root.querySelector(sel);
    const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));
    const clone = (id) => document.getElementById(id).content.cloneNode(true);
    const sleep = (ms) => new Promise(r=>setTimeout(r,ms));
    const debounce = (fn, ms=220) => { let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),ms); } };

    // ---------------- STATE ----------------
    const params = new URL(location.href).searchParams;
    const UID = (params.get('u') || '0412AB34CD5678').trim(); // default demo UID
    const B_HINT = (params.get('b') || '').trim();
    const PRETEND_CLAIMED = params.get('claimed') === '1';
    const NOREDIR = params.get('noredir') === '1';
    if (PRETEND_CLAIMED) CLAIMED.set(UID, `https://pawpayaco.com/?aff=b-1002-${UID.slice(-4)}`);

    $('#uidRibbon').textContent = 'UID: ' + (UID || '—');

    // Theme toggle button
    const themeBtn = document.getElementById('themeBtn');
    themeBtn.addEventListener('click',()=>{
      const html = document.documentElement;
      const next = html.getAttribute('data-theme') === 'aura' ? 'classic' : 'aura';
      html.setAttribute('data-theme', next);
      themeBtn.textContent = 'Theme: ' + (next==='aura'?'Aura':'Classic');
    });

    // ---------------- FLOW ----------------
    const area = $('#statusArea');
    stepLive(1); area.append(clone('tpl-checking'));

    init().catch(err => showError(err?.message || 'Init failed'));

    async function init(){
      if (!UID) throw new Error('Missing UID in URL (?u=...)');
      try{
        const res = await fetch(`/api/claim?u=${encodeURIComponent(UID)}`);
        if (res.ok){
          const data = await res.json();
          const to = data.to || data.affiliateUrl;
          if (to){
            stepDone(1); stepLive(3);
            area.innerHTML = '';
            const frag = clone('tpl-claimed');
            const a = $('a#gotoLink', frag); a.href = to;
            area.append(frag);
            celebrate();
            if (!NOREDIR){ await sleep(700); location.replace(to); }
            return;
          }
        }
      }catch(e){/* continue to search */}

      // Show search UI
      stepDone(1); stepLive(2);
      area.innerHTML = '';
      const frag = clone('tpl-search'); area.append(frag);
      const inp = $('#search'); const list = $('#results');
      if (B_HINT) { inp.value = B_HINT; query(B_HINT); } else { query(''); } inp.focus(); inp.select();

      const doQuery = debounce(v=>query(v), 220);
      inp.addEventListener('input', e=> doQuery(e.target.value));

      async function query(q){
        list.classList.remove('hidden');
        list.innerHTML = '';
        list.append(spinnerRow());
        try{
          const r = await fetch(`/api/businesses?search=${encodeURIComponent(q||'')}`);
          const items = r.ok ? await r.json() : [];
          list.innerHTML = '';
          if (!items.length){ list.append(clone('tpl-empty')); return; }
          for (const b of items.slice(0,12)){
            const row = clone('tpl-item');
            $('.name', row).textContent = b.name || 'Unnamed';
            $('.id', row).textContent = b.id || '—';
            const btn = $('.claimBtn', row);
            btn.addEventListener('click', ()=> claim(UID, b.id, btn));
            list.append(row);
          }
        }catch(e){
          list.innerHTML = '';
          const li = document.createElement('li'); li.className='item';
          li.innerHTML = `<div class="muted">Search error. <button class="btn ghost" onclick="location.reload()">Reload</button></div>`;
          list.append(li);
        }
      }
    }

    function spinnerRow(){
      const li = document.createElement('li'); li.className='item';
      li.innerHTML = `<div class="row"><div class="spinner" style="color:var(--brand)"></div><span class="muted">Loading…</span></div>`;
      return li;
    }

    async function claim(uid, business_id, btn){
      const orig = btn.textContent; btn.disabled = true; btn.innerHTML = `<span class="row" style="gap:8px"><span class="spinner"></span>Claiming…</span>`;
      try{
        const r = await fetch('/api/claim', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ uid, business_id }) });
        const data = await r.json().catch(()=>({}));
        if (r.ok && (data.to || data.affiliateUrl)){
          stepDone(2); stepLive(3);
          const to = data.to || data.affiliateUrl;
          area.innerHTML = '';
          const frag = clone('tpl-claimed');
          $('a#gotoLink', frag).href = to;
          area.append(frag);
          celebrate();
          if (!NOREDIR){ await sleep(300); location.replace(to); }
          return;
        }
        showError(data.error || 'Claim failed.'); btn.disabled = false; btn.textContent = orig;
      }catch(e){ showError('Network error.'); btn.disabled = false; btn.textContent = orig; }
    }

    function showError(msg){
      const area = document.getElementById('statusArea');
      area.innerHTML = '';
      const frag = clone('tpl-error');
      const banner = frag.querySelector('.banner'); banner.textContent = msg;
      frag.getElementById('retryBtn').addEventListener('click', ()=> location.reload());
      frag.getElementById('supportBtn').addEventListener('click', (e)=>{ e.preventDefault(); alert('Demo: open mailto to support with UID.'); });
      area.append(frag);
      stepLive(2);
    }

    function stepLive(n){ [1,2,3].forEach(i=> document.getElementById('s'+i).className = 'step' + (i===n?' live':'')); }
    function stepDone(n){ document.getElementById('s'+n).className = 'step done'; }

    document.getElementById('resetDemo').addEventListener('click', (e)=>{ e.preventDefault(); CLAIMED.clear(); alert('Demo state reset.'); location.href = location.pathname + '?u=0412AB34CD5678'; });

    // ---------- micro-confetti (no deps) ----------
    function celebrate(){
      const c = document.getElementById('fx');
      const d = c.getContext('2d');
      const W = c.width = innerWidth, H = c.height = innerHeight;
      const N = 120; const P = [];
      for(let i=0;i<N;i++) P.push({x:W/2,y:80, vx:(Math.random()-0.5)*6, vy:Math.random()*-6-2, g:0.15+Math.random()*0.1, s:4+Math.random()*3, r:Math.random()*6.28, c:pick()});
      let t=0; const id = requestAnimationFrame(draw); setTimeout(()=>cancelAnimationFrame(id), 1200);
      function draw(){ t++; d.clearRect(0,0,W,H); for(const p of P){ p.vy+=p.g; p.x+=p.vx; p.y+=p.vy; p.r+=0.1; d.save(); d.translate(p.x,p.y); d.rotate(p.r); d.fillStyle=p.c; d.fillRect(-p.s/2,-p.s/2,p.s,p.s); d.restore(); } requestAnimationFrame(draw); }
      function pick(){ const cs=["#ff7a4a","#ff6fb3","#ffd166","#7ae582","#8ecae6"]; return cs[(Math.random()*cs.length)|0]; }
    }
  </script>
</body>
</html>
